# =============================================================================
# TeamSync Presentation - ARM64 Production-Optimized Full Source Build
# =============================================================================
#
# Handles: .pptx, .ppt, .odp
# Platform: linux/arm64 (Apple Silicon, ARM servers)
# Builds LibreOffice and Collabora from source for ARM64
# License: MPL 2.0 Compliant
#
# Production optimizations based on:
# - Docker 2025 best practices (multi-stage, layer caching, minimal base)
# - Collabora Online production recommendations (memory, connections, timeouts)
# - LibreOffice optimization (Impress-only components, stripped binaries)
#
# Performance targets:
# - 10 concurrent users per CPU thread
# - 50MB RAM per user + 1GB system overhead
# - < 100ms presentation load time on warm start
#
# NOTE: This build takes 3-5 hours due to LibreOffice compilation from source
# =============================================================================

# =============================================================================
# STAGE 1: Builder Base - Install build dependencies (cached layer)
# =============================================================================
FROM --platform=linux/arm64 ubuntu:22.04 AS builder-base

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Install build dependencies for LibreOffice compilation
# LibreOffice requires GCC 12+, Ubuntu 22.04 ships with GCC 11
# Sorted alphabetically for maintainability and cache optimization
RUN apt-get update && apt-get install -y --no-install-recommends \
    autoconf \
    automake \
    bison \
    build-essential \
    ca-certificates \
    ccache \
    g++-12 \
    gcc-12 \
    cmake \
    cpio \
    curl \
    doxygen \
    flex \
    fontconfig \
    fonts-liberation \
    fonts-opensymbol \
    git \
    gperf \
    graphviz \
    libabw-dev \
    libatk1.0-dev \
    libboost-all-dev \
    libcairo2-dev \
    libcap-dev \
    libcap2-bin \
    libcdr-dev \
    libclucene-dev \
    libcppunit-dev \
    libcurl4-gnutls-dev \
    libe-book-dev \
    libepoxy-dev \
    libetonyek-dev \
    libexpat1-dev \
    libfontconfig1-dev \
    libfreehand-dev \
    libfreetype-dev \
    libglib2.0-dev \
    libgraphite2-dev \
    libgtk-3-dev \
    libharfbuzz-dev \
    libhunspell-dev \
    libhyphen-dev \
    libicu-dev \
    libjpeg-dev \
    liblangtag-dev \
    liblcms2-dev \
    libmspub-dev \
    libmwaw-dev \
    libmythes-dev \
    libnss3-dev \
    libnspr4-dev \
    libnumbertext-dev \
    liborcus-dev \
    libpagemaker-dev \
    libpam-dev \
    libpango1.0-dev \
    libpixman-1-dev \
    libpng-dev \
    libpoco-dev \
    libqxp-dev \
    librevenge-dev \
    libssl-dev \
    libstaroffice-dev \
    libtool \
    libvisio-dev \
    libwpd-dev \
    libwpg-dev \
    libwps-dev \
    libx11-dev \
    libxcomposite-dev \
    libxcursor-dev \
    libxext-dev \
    libxinerama-dev \
    libxml2-dev \
    libxmlsec1-dev \
    libxrandr-dev \
    libxrender-dev \
    libxslt1-dev \
    libxt-dev \
    libzmf-dev \
    libzstd-dev \
    pkg-config \
    python3 \
    python3-dev \
    python3-lxml \
    python3-polib \
    rsync \
    unzip \
    wget \
    xsltproc \
    xz-utils \
    zip \
    libxml2-utils \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* \
    # Set GCC 12 as default (required by LibreOffice)
    && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100 \
    && update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100 \
    && update-alternatives --install /usr/bin/cc cc /usr/bin/gcc-12 100 \
    && update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++-12 100

# Install Node.js 20 LTS (latest LTS for better performance and security)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && npm cache clean --force \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Setup ccache for faster rebuilds
ENV CCACHE_DIR=/ccache \
    PATH="/usr/lib/ccache:$PATH"
RUN mkdir -p /ccache && chmod 777 /ccache

WORKDIR /build

# =============================================================================
# STAGE 2: Build LibreOffice Core from Source (Impress-optimized)
# =============================================================================
FROM builder-base AS locore

ARG LO_VERSION=libreoffice-24-2-7
ENV LO_BUILD_DIR=/build/libreoffice

WORKDIR /build

# Clone LibreOffice core (shallow clone to save time)
RUN echo "==> Cloning LibreOffice core (v${LO_VERSION})..." \
    && git clone --depth 1 --single-branch --branch ${LO_VERSION} \
       https://github.com/LibreOffice/core.git libreoffice

WORKDIR ${LO_BUILD_DIR}

# Configure LibreOffice - optimized for headless server use with Impress focus
RUN echo "==> Configuring LibreOffice build (Impress-optimized)..." \
    && ./autogen.sh \
    --prefix=/opt/lokit \
    --with-vendor="TeamSync" \
    --with-package-format="" \
    --disable-odk \
    --disable-lotuswordpro \
    --disable-firebird-sdbc \
    --disable-postgresql-sdbc \
    --disable-mariadb-sdbc \
    --disable-gtk3-kde5 \
    --disable-dbus \
    --disable-avahi \
    --disable-gstreamer-1-0 \
    --disable-cups \
    --disable-dconf \
    --disable-gio \
    --disable-gui \
    --disable-sdremote \
    --disable-sdremote-bluetooth \
    --disable-extension-update \
    --disable-extensions \
    --disable-scripting-beanshell \
    --disable-scripting-javascript \
    --disable-report-builder \
    --disable-lpsolve \
    --disable-coinmp \
    --disable-pdfium \
    --disable-pdfimport \
    --disable-poppler \
    --disable-skia \
    --disable-online-update \
    --disable-ccache \
    --enable-release-build \
    --enable-epm \
    --without-java \
    --without-junit \
    --without-doxygen \
    --without-galleries \
    --without-helppack-integration \
    --without-myspell-dicts \
    --without-fonts \
    --with-system-curl \
    --with-system-expat \
    --with-system-icu \
    --with-system-libxml \
    --with-system-openssl \
    --with-system-zlib \
    --with-system-libpng \
    --with-system-jpeg \
    --with-system-boost \
    --with-system-nss \
    --with-system-hunspell \
    --with-system-cairo \
    --with-system-freetype \
    --with-system-fontconfig \
    --with-system-graphite \
    --with-system-libcdr \
    --with-system-libvisio \
    --with-system-libwpd \
    --with-system-libwpg \
    --with-system-libwps \
    --with-system-libmspub \
    --with-system-libmwaw \
    --with-system-libebook \
    --with-system-libabw \
    --with-system-libetonyek \
    --with-system-libfreehand \
    --with-system-libstaroffice \
    --with-system-libzmf \
    --with-system-libpagemaker \
    --with-system-libqxp \
    --with-system-libnumbertext \
    --with-system-liblangtag \
    --with-system-librevenge \
    --with-system-clucene \
    --with-system-epoxy \
    --with-system-lcms2 \
    --with-parallelism=$(nproc) 2>&1 | tee /build/configure.log

# Build LibreOffice (this takes 2-4 hours on ARM64)
RUN echo "==> Building LibreOffice (this will take several hours)..." \
    && make -j$(nproc) build-nocheck 2>&1 | tee /build/lo-build.log

# Install to a staging directory
RUN make DESTDIR=/build/lo-install install

# Create the instdir structure needed by Collabora Online
RUN mkdir -p /build/instdir \
    && if [ -d /build/lo-install/opt/lokit ]; then \
           cp -r /build/lo-install/opt/lokit/* /build/instdir/; \
       elif [ -d ${LO_BUILD_DIR}/instdir ]; then \
           cp -r ${LO_BUILD_DIR}/instdir/* /build/instdir/; \
       fi \
    && echo "==> LibreOffice build complete - instdir size:" \
    && du -sh /build/instdir

# Create include directory for LOKit headers
RUN mkdir -p /build/include \
    && cp -r ${LO_BUILD_DIR}/include/LibreOfficeKit /build/include/

# =============================================================================
# STAGE 3: Build Collabora Online with Branding & Production Optimizations
# =============================================================================
FROM locore AS builder

ARG COOL_VERSION=distro/collabora/co-24.04
ARG BRAND_NAME="TeamSync Presentation"

WORKDIR /build

# Clone source with minimal depth for faster builds
RUN git clone --depth 1 --single-branch --branch ${COOL_VERSION} \
    https://github.com/CollaboraOnline/online.git

# Copy branding assets
COPY docker/branding/presentation/ /build/branding/
COPY docker/branding/LICENSE_NOTICE.txt /build/branding/

# Copy and execute white-label script
COPY docker/scripts/white-label.sh /build/white-label.sh
RUN chmod +x /build/white-label.sh \
    && /build/white-label.sh /build/online /build/branding

# Replace logo files if provided
RUN if [ -f /build/branding/images/logo.svg ]; then \
        find /build/online/browser -type f \( -name "collabora-logo*.svg" -o -name "loleaflet-logo*.svg" \) \
            -exec cp /build/branding/images/logo.svg {} \; 2>/dev/null || true; \
    fi

# Apply custom CSS if provided
RUN if [ -f /build/branding/css/brand-colors.css ]; then \
        cat /build/branding/css/brand-colors.css >> \
            /build/online/browser/src/control/Control.UIManager.css 2>/dev/null || true; \
    fi

# Build browser assets with production optimizations
WORKDIR /build/online/browser
RUN npm install --no-audit \
    && npm cache clean --force

# Configure and build coolwsd with production settings
WORKDIR /build/online
RUN ./autogen.sh

# Configure with production-optimized settings
RUN ./configure \
    --prefix=/opt/cool \
    --with-lokit-path=/build/include \
    --with-lo-path=/opt/lokit \
    --enable-silent-rules \
    --disable-setcap \
    --disable-ssl \
    --with-max-connections=100000 \
    --with-max-documents=10000

# Build with all available CPU cores
RUN make -j$(nproc)
RUN make DESTDIR=/install install

# Prepare LibreOffice installation
RUN mkdir -p /opt/lokit && cp -r /build/instdir/* /opt/lokit/

# =============================================================================
# AGGRESSIVE OPTIMIZATION - Impress-only components
# Removes ~500MB+ of unnecessary components for presentation editing
# =============================================================================
RUN cd /opt/lokit && \
    echo "==> Starting Impress-only optimization..." && \
    # Remove entire applications and components we don't need
    rm -rf \
        help/ \
        sdk/ \
        share/basic/Tutorials/ \
        share/config/images_*.zip \
        share/config/soffice.cfg/scalc/ \
        share/config/soffice.cfg/swriter/ \
        share/config/soffice.cfg/sdraw/ \
        share/config/soffice.cfg/modules/swriter/ \
        share/config/soffice.cfg/modules/scalc/ \
        share/config/soffice.cfg/modules/sdraw/ \
        share/config/soffice.cfg/modules/smath/ \
        share/config/soffice.cfg/modules/dbapp/ \
        share/extensions/ \
        share/gallery/ \
        share/samples/ \
        share/template/ \
        share/wizards/ \
        share/autotext/ \
        share/autocorr/ \
        share/Scripts/ \
        program/classes/ \
        program/wizards/ \
        2>/dev/null || true && \
    # Remove non-English locales (keep en-US, en-GB for international users)
    find share/registry -name "*.xcd" \
        ! -name "main.xcd" \
        ! -name "impress.xcd" \
        ! -name "Langpack-en*.xcd" \
        -delete 2>/dev/null || true && \
    # Keep only essential fonts (Liberation for MS Office compatibility, Open Sans)
    find share/fonts -type f \
        ! -name "Liberation*.ttf" \
        ! -name "opens*.ttf" \
        ! -name "liber*.ttf" \
        -delete 2>/dev/null || true && \
    # Remove empty directories
    find . -type d -empty -delete 2>/dev/null || true && \
    # Strip debug symbols from all binaries and libraries (saves ~30-50%)
    find program -type f \( -name "*.so" -o -name "*.so.*" \) \
        -exec strip --strip-unneeded {} \; 2>/dev/null || true && \
    find program -type f -executable ! -name "*.so*" \
        -exec strip --strip-unneeded {} \; 2>/dev/null || true && \
    echo "==> Impress-only optimization complete"

# Create systemplate with proper timezone support
RUN echo "Etc/UTC" > /etc/timezone \
    && ln -sf /usr/share/zoneinfo/Etc/UTC /etc/localtime \
    && mkdir -p /install/opt/cool/systemplate /install/opt/cool/child-roots \
    && ./coolwsd-systemplate-setup /install/opt/cool/systemplate /opt/lokit || true

# Copy lokit into systemplate (REQUIRED for chroot jails to work)
RUN mkdir -p /install/opt/cool/systemplate/opt \
    && cp -a /opt/lokit /install/opt/cool/systemplate/opt/lokit

# Strip coolwsd binaries for smaller image
RUN find /install/opt/cool/bin -type f -executable \
    -exec strip --strip-unneeded {} \; 2>/dev/null || true

# Generate size report for build verification
RUN echo "=== BUILD SIZE REPORT ===" \
    && echo "LibreOffice kit:" && du -sh /opt/lokit \
    && echo "Systemplate:" && du -sh /install/opt/cool/systemplate \
    && echo "COOL binaries:" && du -sh /install/opt/cool/bin \
    && echo "========================="

# =============================================================================
# STAGE 4: Production Runtime Image (Minimal footprint)
# =============================================================================
FROM --platform=linux/arm64 ubuntu:22.04 AS runtime

# Production environment configuration
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    TEAMSYNC_PRODUCT="presentation" \
    # Collabora Online performance tuning defaults
    MEMPROPORTION=80.0 \
    MAX_CONNECTIONS=100000 \
    MAX_DOCUMENTS=10000 \
    # Disable core dumps in production
    COOL_NO_DUMP=1

# OCI Image Labels for container registries
LABEL maintainer="TeamSync <support@teamsync.io>" \
      org.opencontainers.image.title="TeamSync Presentation (ARM64)" \
      org.opencontainers.image.description="Production-optimized collaborative presentation editing for ARM64 - built from source" \
      org.opencontainers.image.licenses="MPL-2.0" \
      org.opencontainers.image.vendor="TeamSync" \
      org.opencontainers.image.source="https://github.com/angelbot-ai/teamsync-editor" \
      teamsync.product="presentation" \
      teamsync.filetypes="pptx,ppt,odp" \
      teamsync.architecture="arm64" \
      teamsync.build="source" \
      teamsync.version="1.0.0"

# Install minimal runtime dependencies in single optimized layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core system libraries
    libcap2 \
    libcap2-bin \
    libpng16-16 \
    libssl3 \
    libpam0g \
    libzstd1 \
    # Poco runtime libraries (networking, crypto, XML parsing)
    libpocofoundation80 \
    libpoconet80 \
    libpoconetssl80 \
    libpococrypto80 \
    libpocoutil80 \
    libpocoxml80 \
    libpocojson80 \
    # System utilities
    ca-certificates \
    curl \
    tzdata \
    # Font rendering
    fontconfig \
    fonts-liberation \
    # Spell checking (English only)
    hunspell \
    hunspell-en-us \
    # LibreOffice runtime dependencies (ARM64)
    libfreetype6 \
    libfontconfig1 \
    libharfbuzz0b \
    libicu70 \
    libexpat1 \
    libxml2 \
    libxslt1.1 \
    libnss3 \
    libnspr4 \
    libcairo2 \
    libpixman-1-0 \
    libglib2.0-0 \
    libatk1.0-0 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libx11-6 \
    libxext6 \
    libxrender1 \
    libepoxy0 \
    liblcms2-2 \
    libhunspell-1.7-0 \
    libboost-filesystem1.74.0 \
    libboost-locale1.74.0 \
    libgraphite2-3 \
    liborcus-0.17-0 \
    libcdr-0.1-1 \
    libvisio-0.1-1 \
    libwpd-0.10-10 \
    libwpg-0.3-3 \
    libwps-0.4-4 \
    libmspub-0.1-1 \
    libe-book-0.1-1 \
    libabw-0.1-1 \
    libetonyek-0.1-1 \
    libfreehand-0.1-1 \
    libstaroffice-0.0-0 \
    libzmf-0.0-0 \
    libpagemaker-0.0-0 \
    libqxp-0.0-0 \
    liblangtag1 \
    librevenge-0.0-0 \
    libclucene-core1v5 \
    libxmlsec1-openssl \
    && apt-get clean \
    && rm -rf \
        /var/lib/apt/lists/* \
        /tmp/* \
        /var/tmp/* \
        /usr/share/doc/* \
        /usr/share/man/* \
        /usr/share/info/* \
        /usr/share/lintian/*

# Create non-root service user (security best practice)
RUN useradd -r -m -d /opt/cool -s /bin/false -c "Collabora Online" cool

# Create required directories with proper ownership
RUN mkdir -p \
    /opt/cool/systemplate \
    /opt/cool/child-roots \
    /opt/cool/browser \
    /opt/cool/tmp \
    /etc/coolwsd \
    /var/log/coolwsd \
    /var/cache/coolwsd \
    /tmp/coolwsd \
    && chown -R cool:cool /opt/cool /var/log/coolwsd /var/cache/coolwsd /tmp/coolwsd

# Copy built artifacts from builder stage with ownership
COPY --from=builder --chown=cool:cool /install/opt/cool/bin /opt/cool/bin
COPY --from=builder --chown=cool:cool /install/opt/cool/share /opt/cool/share
COPY --from=builder --chown=cool:cool /install/opt/cool/child-roots /opt/cool/child-roots
COPY --from=builder --chown=cool:cool /install/opt/cool/systemplate /opt/cool/systemplate
COPY --from=builder --chown=cool:cool /opt/lokit /opt/lokit
COPY --from=builder /build/online/coolwsd.xml /etc/coolwsd/coolwsd.xml

# Copy license notice
COPY docker/branding/LICENSE_NOTICE.txt /opt/cool/LICENSE_NOTICE.txt

# Setup symlinks for coolwsd operation
RUN ln -sf /opt/cool/share/coolwsd/browser /opt/cool/bin/browser \
    && ln -sf /opt/cool/share/coolwsd/discovery.xml /opt/cool/bin/discovery.xml \
    && ln -sf /opt/cool/share/coolwsd/favicon.ico /opt/cool/bin/favicon.ico \
    && ln -sf /opt/cool/systemplate /opt/cool/bin/systemplate \
    && mkdir -p /opt/cool/bin/jails \
    && chown -R cool:cool /opt/cool \
    && chmod 755 /opt/cool/bin/*

# Set Linux capabilities for jail creation (required for secure document isolation)
RUN setcap cap_fowner,cap_chown,cap_mknod,cap_sys_chroot=ep /opt/cool/bin/coolforkit-caps 2>/dev/null || \
    setcap cap_fowner,cap_chown,cap_mknod,cap_sys_chroot=ep /opt/cool/bin/coolforkit-ns 2>/dev/null || true

# Copy entrypoint script
COPY --chmod=755 docker/scripts/entrypoint.sh /entrypoint.sh

# Expose default port
EXPOSE 9980

# Production-ready healthcheck
# - 180s start period allows for LibreOffice initialization under load
# - 30s interval is optimal for load balancer integration
# - 3 retries prevents false positives during brief hiccups
HEALTHCHECK --interval=30s --timeout=10s --start-period=180s --retries=3 \
    CMD curl -sf http://localhost:${PORT:-9980}/hosting/discovery > /dev/null || exit 1

WORKDIR /opt/cool

ENTRYPOINT ["/entrypoint.sh"]
